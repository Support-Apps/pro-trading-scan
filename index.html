<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TradeScan Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0B0E11;
            --card: #1a1d21;
            --border: rgba(255,255,255,0.08);
            --gold: #F0B90B;
            --green: #0ECB81;
            --red: #F6465D;
            --text: #EAECEF;
            --dim: #848E9C;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* INTRO PAGE */
        .intro-page {
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .intro-page.hidden { display: none; }
        
        .intro-header {
            text-align: center;
            padding: 30px 0 20px;
        }
        
        .intro-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, var(--gold), #D4A017);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 30px rgba(240, 185, 11, 0.3);
        }
        
        .intro-header h1 {
            font-size: 1.8em;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .intro-header p { color: var(--dim); font-size: 0.9em; margin-top: 4px; }
        
        .intro-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        
        .intro-card h3 { font-size: 1em; margin-bottom: 12px; }
        .intro-card p { color: var(--dim); font-size: 0.85em; line-height: 1.6; }
        
        .pattern-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        
        .tag {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .tag.green { background: rgba(14,203,129,0.15); color: var(--green); }
        .tag.red { background: rgba(246,70,93,0.15); color: var(--red); }
        .tag.gold { background: rgba(240,185,11,0.15); color: var(--gold); }
        
        .disclaimer {
            background: rgba(246,70,93,0.08);
            border: 1px solid rgba(246,70,93,0.2);
            border-radius: 12px;
            padding: 14px;
        }
        
        .disclaimer p { font-size: 0.8em; color: var(--dim); }
        .disclaimer strong { color: var(--red); }
        
        .intro-btn-wrap {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px 28px;
            background: linear-gradient(0deg, var(--bg) 70%, transparent);
        }
        
        .intro-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, var(--gold), #D4A017);
            color: #000;
        }
        
        /* SCANNER PAGE */
        .scanner-page {
            display: none;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }
        
        .scanner-page.active { display: flex; }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }
        
        .logo-sm {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }
        
        .logo-sm .icon {
            width: 28px;
            height: 28px;
            background: var(--gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #000;
            font-weight: 800;
        }
        
        .logo-sm span { color: var(--gold); }
        
        .back-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--dim);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        /* CAMERA */
        .camera-area {
            position: relative;
            margin: 8px;
            border-radius: 14px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
            border: 2px solid var(--border);
        }
        
        #video { width: 100%; height: 100%; object-fit: cover; display: none; }
        #video.active { display: block; }
        #canvas { display: none; }
        
        .cam-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #12151a, #0a0c0f);
        }
        
        .cam-placeholder.hidden { display: none; }
        .cam-placeholder .icon { font-size: 32px; margin-bottom: 8px; }
        .cam-placeholder p { color: var(--dim); font-size: 0.85em; }
        
        .scan-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: none;
        }
        
        .scan-overlay.active { display: block; }
        
        .scan-frame {
            position: absolute;
            top: 5%; left: 3%; right: 3%; bottom: 5%;
            border: 2px solid rgba(240,185,11,0.4);
            border-radius: 10px;
        }
        
        .scan-line {
            position: absolute;
            left: 3%; right: 3%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            box-shadow: 0 0 15px var(--gold);
            animation: scanMove 2s ease-in-out infinite;
        }
        
        @keyframes scanMove {
            0%, 100% { top: 8%; }
            50% { top: 90%; }
        }
        
        .cam-hud {
            position: absolute;
            bottom: 6px;
            left: 6px;
            right: 6px;
            display: flex;
            justify-content: space-between;
        }
        
        .hud-item {
            background: rgba(0,0,0,0.8);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .hud-item .val { color: var(--gold); font-weight: 600; }
        .hud-item.live { color: var(--red); }
        
        /* DATA PANEL */
        .data-panel {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }
        
        /* SIGNAL CARD */
        .signal-card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .signal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .signal-icon.bullish { background: rgba(14,203,129,0.15); }
        .signal-icon.bearish { background: rgba(246,70,93,0.15); }
        .signal-icon.neutral { background: rgba(240,185,11,0.15); }
        
        .signal-info { flex: 1; }
        .signal-info .direction { font-size: 1.15em; font-weight: 800; }
        .signal-info .direction.bullish { color: var(--green); }
        .signal-info .direction.bearish { color: var(--red); }
        .signal-info .direction.neutral { color: var(--gold); }
        .signal-info .meta { font-size: 0.75em; color: var(--dim); margin-top: 2px; }
        
        .signal-conf { text-align: center; }
        .signal-conf .num { font-size: 1.5em; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .signal-conf .num.bullish { color: var(--green); }
        .signal-conf .num.bearish { color: var(--red); }
        .signal-conf .num.neutral { color: var(--gold); }
        .signal-conf .lbl { font-size: 0.6em; color: var(--dim); }
        
        /* PREDICTION */
        .prediction {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .prediction.bullish { border-left: 3px solid var(--green); }
        .prediction.bearish { border-left: 3px solid var(--red); }
        .prediction.neutral { border-left: 3px solid var(--gold); }
        
        .prediction .icon { font-size: 22px; }
        .prediction .text { flex: 1; }
        .prediction .text strong { font-size: 0.9em; display: block; margin-bottom: 2px; }
        .prediction .text span { font-size: 0.75em; color: var(--dim); }
        
        .prediction .action {
            font-size: 0.72em;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 700;
        }
        
        .prediction .action.buy { background: rgba(14,203,129,0.15); color: var(--green); }
        .prediction .action.sell { background: rgba(246,70,93,0.15); color: var(--red); }
        .prediction .action.wait { background: rgba(240,185,11,0.15); color: var(--gold); }
        
        /* PATTERNS */
        .patterns-box {
            background: var(--card);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border);
        }
        
        .patterns-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--dim);
            margin-bottom: 8px;
        }
        
        .patterns-chips { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .pat-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 7px 11px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 600;
        }
        
        .pat-chip.bullish { background: rgba(14,203,129,0.12); color: var(--green); }
        .pat-chip.bearish { background: rgba(246,70,93,0.12); color: var(--red); }
        .pat-chip.neutral { background: rgba(240,185,11,0.12); color: var(--gold); }
        
        .no-patterns { text-align: center; padding: 15px; color: var(--dim); font-size: 0.85em; }
        
        /* EMPTY STATE */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--dim);
            padding: 20px;
        }
        
        .empty-state .icon { font-size: 36px; margin-bottom: 10px; }
        .empty-state p { font-size: 0.85em; line-height: 1.5; }
        
        /* SCAN BUTTON */
        .scan-btn-area { padding: 8px 8px 20px; }
        
        .scan-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .scan-btn.start { background: linear-gradient(135deg, var(--green), #00B37D); color: #fff; }
        .scan-btn.stop { background: linear-gradient(135deg, var(--red), #D63850); color: #fff; }
    </style>
</head>
<body>
    <!-- INTRO -->
    <div class="intro-page" id="introPage">
        <div class="intro-header">
            <div class="intro-logo">üìà</div>
            <h1>TradeScan Pro</h1>
            <p>AI Candlestick Pattern Scanner</p>
        </div>
        
        <div class="intro-card">
            <h3>üéØ Real-Time Chart Analysis</h3>
            <p>Point your camera at any candlestick chart. AI detects patterns and predicts market direction instantly.</p>
        </div>
        
        <div class="intro-card">
            <h3>üïØÔ∏è Detected Patterns</h3>
            <div class="pattern-tags">
                <span class="tag green">üî® Hammer</span>
                <span class="tag green">ü´Ç Bullish Engulfing</span>
                <span class="tag green">‚≠ê Morning Star</span>
                <span class="tag green">üë®‚Äçüë®‚Äçüë¶ 3 White Soldiers</span>
                <span class="tag red">üí´ Shooting Star</span>
                <span class="tag red">ü´Ç Bearish Engulfing</span>
                <span class="tag red">üåô Evening Star</span>
                <span class="tag red">üê¶‚Äç‚¨õ 3 Black Crows</span>
                <span class="tag gold">‚ûï Doji</span>
                <span class="tag gold">üéØ Spinning Top</span>
            </div>
        </div>
        
        <div class="intro-card">
            <h3>üìä Pattern Success Rates</h3>
            <p><strong>3 White Soldiers (82%)</strong> - 3 consecutive rising green candles. Strong bullish signal.</p>
            <p style="margin-top:8px;"><strong>Bearish Engulfing (79%)</strong> - Large red candle engulfs previous green. Strong reversal.</p>
            <p style="margin-top:8px;"><strong>Morning Star (78%)</strong> - 3-candle bottom reversal pattern.</p>
        </div>
        
        <div class="disclaimer">
            <p>‚ö†Ô∏è <strong>Risk Warning:</strong> Educational tool only. Not financial advice. Always use stop-losses.</p>
        </div>
        
        <div class="intro-btn-wrap">
            <button class="intro-btn" onclick="showScanner()">‚Üí Open Scanner</button>
        </div>
    </div>
    
    <!-- SCANNER -->
    <div class="scanner-page" id="scannerPage">
        <div class="top-bar">
            <div class="logo-sm">
                <div class="icon">TS</div>
                Trade<span>Scan</span>
            </div>
            <button class="back-btn" onclick="showIntro()">‚Üê Back</button>
        </div>
        
        <div class="camera-area">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            
            <div class="cam-placeholder" id="placeholder">
                <div class="icon">üì∑</div>
                <p>Camera ready</p>
            </div>
            
            <div class="scan-overlay" id="overlay">
                <div class="scan-frame"></div>
                <div class="scan-line"></div>
                <div class="cam-hud">
                    <div class="hud-item" style="visibility:hidden;">CANDLES <span class="val" id="candleNum">0</span></div>
                    <div class="hud-item live" id="liveInd" style="display:none;">‚óè LIVE</div>
                </div>
            </div>
        </div>
        
        <div class="data-panel" id="dataPanel">
            <div class="empty-state" id="emptyState">
                <div class="icon">üîç</div>
                <p>Point camera at candlestick chart<br>and tap Start Scanning</p>
            </div>
        </div>
        
        <div class="scan-btn-area">
            <button class="scan-btn start" id="scanBtn" onclick="toggleScan()">
                <span id="btnIcon">‚ñ∂</span>
                <span id="btnText">Start Scanning</span>
            </button>
        </div>
    </div>
    
    <script>
        var scanning = false;
        var stream = null;
        var animId = null;
        
        var video, canvas, ctx, placeholder, overlay, dataPanel, emptyState;
        var candleNum, liveInd, scanBtn, btnIcon, btnText;
        
        function showScanner() {
            document.getElementById('introPage').classList.add('hidden');
            document.getElementById('scannerPage').classList.add('active');
        }
        
        function showIntro() {
            stopScan();
            document.getElementById('scannerPage').classList.remove('active');
            document.getElementById('introPage').classList.remove('hidden');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            placeholder = document.getElementById('placeholder');
            overlay = document.getElementById('overlay');
            dataPanel = document.getElementById('dataPanel');
            emptyState = document.getElementById('emptyState');
            candleNum = document.getElementById('candleNum');
            liveInd = document.getElementById('liveInd');
            scanBtn = document.getElementById('scanBtn');
            btnIcon = document.getElementById('btnIcon');
            btnText = document.getElementById('btnText');
        });
        
        function toggleScan() {
            if (scanning) stopScan();
            else startScan();
        }
        
        function startScan() {
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
            }).then(function(s) {
                stream = s;
                video.srcObject = stream;
                video.classList.add('active');
                
                video.onloadedmetadata = function() {
                    scanning = true;
                    placeholder.classList.add('hidden');
                    overlay.classList.add('active');
                    liveInd.style.display = 'block';
                    
                    scanBtn.className = 'scan-btn stop';
                    btnIcon.textContent = '‚èπ';
                    btnText.textContent = 'Stop Scanning';
                    
                    animId = requestAnimationFrame(analyze);
                };
            }).catch(function(e) {
                alert('Camera error: ' + e.message);
            });
        }
        
        function stopScan() {
            scanning = false;
            
            if (animId) cancelAnimationFrame(animId);
            if (stream) {
                stream.getTracks().forEach(function(t) { t.stop(); });
            }
            
            video.srcObject = null;
            video.classList.remove('active');
            placeholder.classList.remove('hidden');
            overlay.classList.remove('active');
            liveInd.style.display = 'none';
            
            scanBtn.className = 'scan-btn start';
            btnIcon.textContent = '‚ñ∂';
            btnText.textContent = 'Start Scanning';
            
            dataPanel.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><p>Scan complete</p></div>';
        }
        
        var frameCount = 0;
        function analyze() {
            if (!scanning) return;
            
            frameCount++;
            if (frameCount % 4 === 0) {
                doAnalysis();
            }
            
            animId = requestAnimationFrame(analyze);
        }
        
        function doAnalysis() {
            if (!video.videoWidth) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var candles = detectCandles(imgData);
            
            candleNum.textContent = candles.length;
            
            if (candles.length >= 3) {
                var result = analyzePatterns(candles);
                renderResults(result); // Show immediately - LIVE!
            } else {
                dataPanel.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>Looking for candles...<br>Point camera at chart</p></div>';
            }
        }
        
        // SIMPLE AND WORKING CANDLE DETECTION
        function detectCandles(imgData) {
            var data = imgData.data;
            var w = imgData.width;
            var h = imgData.height;
            var candles = [];
            
            var scanTop = Math.floor(h * 0.1);
            var scanBot = Math.floor(h * 0.9);
            var scanLeft = Math.floor(w * 0.05);
            var scanRight = Math.floor(w * 0.95);
            var scanH = scanBot - scanTop;
            var scanW = scanRight - scanLeft;
            
            var cols = [];
            var step = Math.max(1, Math.floor(scanW / 200));
            
            for (var x = scanLeft; x < scanRight; x += step) {
                var greenPx = 0, redPx = 0;
                var greenTop = scanBot, greenBot = scanTop;
                var redTop = scanBot, redBot = scanTop;
                
                for (var y = scanTop; y < scanBot; y++) {
                    var i = (y * w + x) * 4;
                    var r = data[i];
                    var g = data[i + 1];
                    var b = data[i + 2];
                    
                    // === COLOR DETECTION ===
                    // Green candle = BULLISH (price went UP)
                    // Red candle = BEARISH (price went DOWN)
                    
                    var isGreen = false;
                    var isRed = false;
                    
                    // --- GREEN DETECTION ---
                    // TradingView teal-green: rgb(38, 166, 154)
                    // Also catches: lime, emerald, cyan-green
                    
                    if (g > r && g > 50) {
                        // G is dominant
                        if (g - r > 15) isGreen = true;
                        // Teal (g and b similar, both > r)
                        if (g > r + 30 && b > r) isGreen = true;
                    }
                    // Bright green
                    if (g > 100 && g > r * 1.2 && g > b * 0.9) isGreen = true;
                    
                    // --- RED DETECTION ---
                    // TradingView red: rgb(239, 83, 80)
                    // Also catches: coral, salmon, crimson
                    
                    if (r > g && r > 50) {
                        // R is dominant
                        if (r - g > 15) isRed = true;
                        // Coral red (r high, g medium, b lower)
                        if (r > g + 30 && r > b) isRed = true;
                    }
                    // Bright red
                    if (r > 100 && r > g * 1.2 && r > b) isRed = true;
                    
                    // --- RESOLVE CONFLICTS ---
                    if (isGreen && isRed) {
                        // Pick the stronger one
                        if (g - r > r - g) {
                            isRed = false;
                        } else {
                            isGreen = false;
                        }
                    }
                    
                    if (isGreen && !isRed) {
                        greenPx++;
                        if (y < greenTop) greenTop = y;
                        if (y > greenBot) greenBot = y;
                    } else if (isRed && !isGreen) {
                        redPx++;
                        if (y < redTop) redTop = y;
                        if (y > redBot) redBot = y;
                    }
                }
                
                var minPx = Math.floor(scanH * 0.01);
                
                if (greenPx > minPx && greenPx > redPx) {
                    cols.push({ x: x, type: 'bullish', top: greenTop, bot: greenBot });
                } else if (redPx > minPx && redPx > greenPx) {
                    cols.push({ x: x, type: 'bearish', top: redTop, bot: redBot });
                }
            }
            
            if (cols.length === 0) return candles;
            
            // Group columns into candles
            var cur = { x: cols[0].x, type: cols[0].type, top: cols[0].top, bot: cols[0].bot, n: 1 };
            var minGap = Math.max(3, Math.floor(scanW / 60));
            
            for (var i = 1; i < cols.length; i++) {
                var c = cols[i];
                var gap = c.x - cur.x;
                
                if (gap < minGap && c.type === cur.type) {
                    cur.top = Math.min(cur.top, c.top);
                    cur.bot = Math.max(cur.bot, c.bot);
                    cur.n++;
                } else {
                    if (cur.n >= 1) {
                        candles.push(makeCandle(cur, scanTop, scanBot));
                    }
                    cur = { x: c.x, type: c.type, top: c.top, bot: c.bot, n: 1 };
                }
            }
            
            if (cur.n >= 1) {
                candles.push(makeCandle(cur, scanTop, scanBot));
            }
            
            if (candles.length > 25) {
                candles = candles.slice(-25);
            }
            
            return candles;
        }
        
        function makeCandle(c, scanTop, scanBot) {
            var range = scanBot - scanTop;
            var high = 100 - ((c.top - scanTop) / range * 100);
            var low = 100 - ((c.bot - scanTop) / range * 100);
            var open, close;
            
            if (c.type === 'bullish') {
                open = low + (high - low) * 0.15;
                close = high - (high - low) * 0.15;
            } else {
                open = high - (high - low) * 0.15;
                close = low + (high - low) * 0.15;
            }
            
            return { open: open, high: high, low: low, close: close, type: c.type };
        }
        
        // PATTERN ANALYSIS - Focus on LAST candles (rightmost = most recent)
        function analyzePatterns(candles) {
            var patterns = [];
            
            // Take only LAST 5 candles for pattern detection (most recent!)
            var lastCandles = candles.slice(-5);
            var last = lastCandles[lastCandles.length - 1];
            
            // Single candle patterns (last candle only)
            if (last) {
                var body = Math.abs(last.close - last.open);
                var range = last.high - last.low;
                var upWick = last.high - Math.max(last.open, last.close);
                var loWick = Math.min(last.open, last.close) - last.low;
                
                if (range > 0 && body / range < 0.1) {
                    patterns.push({ name: 'Doji', type: 'neutral', icon: '‚ûï', rate: 50 });
                }
                
                if (range > 0 && loWick > body * 2 && upWick < body * 0.5) {
                    patterns.push({ name: 'Hammer', type: 'bullish', icon: 'üî®', rate: 60 });
                }
                
                if (range > 0 && upWick > body * 2 && loWick < body * 0.5) {
                    patterns.push({ name: 'Shooting Star', type: 'bearish', icon: 'üí´', rate: 59 });
                }
            }
            
            // Two candle patterns (last 2 candles)
            if (lastCandles.length >= 2) {
                var cur = lastCandles[lastCandles.length - 1];
                var prv = lastCandles[lastCandles.length - 2];
                var curB = Math.abs(cur.close - cur.open);
                var prvB = Math.abs(prv.close - prv.open);
                
                if (prv.type === 'bearish' && cur.type === 'bullish' && curB > prvB) {
                    patterns.push({ name: 'Bullish Engulfing', type: 'bullish', icon: 'ü´Ç', rate: 63 });
                }
                
                if (prv.type === 'bullish' && cur.type === 'bearish' && curB > prvB) {
                    patterns.push({ name: 'Bearish Engulfing', type: 'bearish', icon: 'ü´Ç', rate: 79 });
                }
            }
            
            // Three candle patterns (last 3 candles only!)
            if (lastCandles.length >= 3) {
                var c1 = lastCandles[lastCandles.length - 3];
                var c2 = lastCandles[lastCandles.length - 2];
                var c3 = lastCandles[lastCandles.length - 1];
                
                // 3 White Soldiers - last 3 candles are ALL green
                if (c1.type === 'bullish' && c2.type === 'bullish' && c3.type === 'bullish') {
                    patterns.push({ name: '3 White Soldiers', type: 'bullish', icon: 'üë®‚Äçüë®‚Äçüë¶', rate: 82 });
                }
                
                // 3 Black Crows - last 3 candles are ALL red
                if (c1.type === 'bearish' && c2.type === 'bearish' && c3.type === 'bearish') {
                    patterns.push({ name: '3 Black Crows', type: 'bearish', icon: 'üê¶‚Äç‚¨õ', rate: 78 });
                }
            }
            
            // Calculate direction based on LAST 10 candles only
            var recentCandles = candles.slice(-10);
            var greenCount = 0;
            var redCount = 0;
            
            recentCandles.forEach(function(c) {
                if (c.type === 'bullish') greenCount++;
                else if (c.type === 'bearish') redCount++;
            });
            
            // Direction based on majority of recent candles
            var dir, conf;
            var total = greenCount + redCount;
            
            if (greenCount > redCount) {
                dir = 'bullish';
                conf = Math.round((greenCount / total) * 100);
            } else if (redCount > greenCount) {
                dir = 'bearish';
                conf = Math.round((redCount / total) * 100);
            } else {
                dir = 'neutral';
                conf = 50;
            }
            
            // Boost confidence if patterns support direction
            patterns.forEach(function(p) {
                if (p.type === dir) conf = Math.min(95, conf + 10);
            });
            
            return {
                dir: dir,
                conf: conf,
                patterns: patterns.slice(0, 4),
                bullish: greenCount,
                bearish: redCount,
                total: candles.length
            };
        }
        
        function renderResults(r) {
            var icons = { bullish: 'üìà', bearish: 'üìâ', neutral: 'üìä' };
            var labels = { bullish: 'BULLISH', bearish: 'BEARISH', neutral: 'NEUTRAL' };
            
            // Calculate prediction
            var pred = { dir: 'neutral', title: 'WAIT', reason: 'No clear signal', action: 'WAIT', cls: 'wait' };
            
            if (r.patterns.length > 0) {
                var bestPat = r.patterns[0];
                if (bestPat.type === 'bullish') {
                    pred = { dir: 'bullish', title: 'Likely UP ‚ÜóÔ∏è', reason: bestPat.name + ' (' + bestPat.rate + '%)', action: 'BUY', cls: 'buy' };
                } else if (bestPat.type === 'bearish') {
                    pred = { dir: 'bearish', title: 'Likely DOWN ‚ÜòÔ∏è', reason: bestPat.name + ' (' + bestPat.rate + '%)', action: 'SELL', cls: 'sell' };
                }
            } else if (r.dir === 'bullish' && r.conf >= 65) {
                pred = { dir: 'bullish', title: 'Trend UP ‚ÜóÔ∏è', reason: 'Bullish momentum', action: 'BUY', cls: 'buy' };
            } else if (r.dir === 'bearish' && r.conf >= 65) {
                pred = { dir: 'bearish', title: 'Trend DOWN ‚ÜòÔ∏è', reason: 'Bearish momentum', action: 'SELL', cls: 'sell' };
            }
            
            var patsHTML = '';
            if (r.patterns.length > 0) {
                r.patterns.forEach(function(p) {
                    patsHTML += '<div class="pat-chip ' + p.type + '">' + p.icon + ' ' + p.name + '</div>';
                });
            } else {
                patsHTML = '<div class="no-patterns">No patterns detected</div>';
            }
            
            dataPanel.innerHTML = 
                '<div class="signal-card">' +
                    '<div class="signal-icon ' + r.dir + '">' + icons[r.dir] + '</div>' +
                    '<div class="signal-info">' +
                        '<div class="direction ' + r.dir + '">' + labels[r.dir] + '</div>' +
                        '<div class="meta">' + r.bullish + ' green ¬∑ ' + r.bearish + ' red ¬∑ ' + r.total + ' total</div>' +
                    '</div>' +
                    '<div class="signal-conf">' +
                        '<div class="num ' + r.dir + '">' + r.conf + '%</div>' +
                        '<div class="lbl">Confidence</div>' +
                    '</div>' +
                '</div>' +
                '<div class="prediction ' + pred.dir + '">' +
                    '<div class="icon">üéØ</div>' +
                    '<div class="text">' +
                        '<strong>NEXT: ' + pred.title + '</strong>' +
                        '<span>' + pred.reason + '</span>' +
                    '</div>' +
                    '<div class="action ' + pred.cls + '">' + pred.action + '</div>' +
                '</div>' +
                '<div class="patterns-box">' +
                    '<div class="patterns-header">' +
                        '<span>üïØÔ∏è Patterns</span>' +
                        '<span>' + r.patterns.length + ' found</span>' +
                    '</div>' +
                    '<div class="patterns-chips">' + patsHTML + '</div>' +
                '</div>';
        }
    </script>
</body>
</html>
