<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TradeScan Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0B0E11; --card: #1a1d21; --border: rgba(255,255,255,0.08); --gold: #F0B90B; --green: #0ECB81; --red: #F6465D; --text: #EAECEF; --dim: #848E9C; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .page { padding: 15px; }
        .camera-area { position: relative; border-radius: 14px; overflow: hidden; background: #000; aspect-ratio: 16/9; border: 2px solid var(--border); margin-bottom: 15px; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; }
        .live-badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 6px; font-size: 0.7em; color: var(--red); }
        .result-box { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        .direction { font-size: 2em; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .direction.bullish { color: var(--green); }
        .direction.bearish { color: var(--red); }
        .direction.neutral { color: var(--gold); }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; }
        .stat .num { font-size: 1.8em; font-weight: 800; }
        .stat .num.green { color: var(--green); }
        .stat .num.red { color: var(--red); }
        .stat .lbl { font-size: 0.8em; color: var(--dim); }
        .debug { background: #1a1a2e; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.7em; color: #888; margin-top: 10px; max-height: 100px; overflow-y: auto; }
        .patterns { margin-top: 15px; }
        .pat { display: inline-block; padding: 8px 12px; border-radius: 8px; margin: 4px; font-size: 0.85em; font-weight: 600; }
        .pat.bullish { background: rgba(14,203,129,0.15); color: var(--green); }
        .pat.bearish { background: rgba(246,70,93,0.15); color: var(--red); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; }
        .btn.start { background: var(--green); color: #fff; }
        .btn.stop { background: var(--red); color: #fff; }
    </style>
</head>
<body>
    <div class="page">
        <div class="camera-area">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="live-badge" id="liveBadge" style="display:none;">‚óè LIVE</div>
        </div>
        
        <div class="result-box">
            <div class="direction neutral" id="direction">WAITING</div>
            <div class="stats">
                <div class="stat">
                    <div class="num green" id="greenCount">0</div>
                    <div class="lbl">GREEN (Bullish)</div>
                </div>
                <div class="stat">
                    <div class="num red" id="redCount">0</div>
                    <div class="lbl">RED (Bearish)</div>
                </div>
            </div>
            <div class="patterns" id="patterns"></div>
            <div class="debug" id="debug">Debug info...</div>
        </div>
        
        <button class="btn start" id="scanBtn" onclick="toggleScan()">Start Scanning</button>
    </div>

<script>
var scanning = false;
var stream = null;
var video, canvas, ctx;
var historyResults = [];

document.addEventListener('DOMContentLoaded', function() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d', { willReadFrequently: true });
});

function toggleScan() {
    if (scanning) stopScan();
    else startScan();
}

function startScan() {
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(function(s) {
        stream = s;
        video.srcObject = stream;
        scanning = true;
        historyResults = [];
        document.getElementById('liveBadge').style.display = 'block';
        document.getElementById('scanBtn').className = 'btn stop';
        document.getElementById('scanBtn').textContent = 'Stop Scanning';
        analyze();
    }).catch(function(e) {
        alert('Camera error: ' + e.message);
    });
}

function stopScan() {
    scanning = false;
    if (stream) stream.getTracks().forEach(function(t) { t.stop(); });
    document.getElementById('liveBadge').style.display = 'none';
    document.getElementById('scanBtn').className = 'btn start';
    document.getElementById('scanBtn').textContent = 'Start Scanning';
}

function analyze() {
    if (!scanning) return;
    
    if (video.videoWidth > 0) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var result = detectCandles(imgData);
        
        // Add to history for stability
        historyResults.push(result);
        if (historyResults.length > 8) historyResults.shift();
        
        // Get stable result from history
        var stable = getStableResult();
        
        // Update display
        document.getElementById('greenCount').textContent = stable.green;
        document.getElementById('redCount').textContent = stable.red;
        
        var dirEl = document.getElementById('direction');
        if (stable.green > stable.red) {
            dirEl.textContent = 'üìà BULLISH';
            dirEl.className = 'direction bullish';
        } else if (stable.red > stable.green) {
            dirEl.textContent = 'üìâ BEARISH';
            dirEl.className = 'direction bearish';
        } else {
            dirEl.textContent = 'üìä NEUTRAL';
            dirEl.className = 'direction neutral';
        }
        
        // Patterns
        var patsHTML = '';
        stable.patterns.forEach(function(p) {
            patsHTML += '<span class="pat ' + p.type + '">' + p.icon + ' ' + p.name + '</span>';
        });
        document.getElementById('patterns').innerHTML = patsHTML || '<span style="color:#666">No patterns</span>';
        
        // Debug
        document.getElementById('debug').innerHTML = result.debug;
    }
    
    setTimeout(analyze, 250);
}

function getStableResult() {
    if (historyResults.length === 0) return { green: 0, red: 0, patterns: [] };
    
    var totalGreen = 0, totalRed = 0;
    var patternCounts = {};
    
    historyResults.forEach(function(r) {
        totalGreen += r.green;
        totalRed += r.red;
        r.patterns.forEach(function(p) {
            patternCounts[p.name] = patternCounts[p.name] || { count: 0, data: p };
            patternCounts[p.name].count++;
        });
    });
    
    var avgGreen = Math.round(totalGreen / historyResults.length);
    var avgRed = Math.round(totalRed / historyResults.length);
    
    // Only show patterns that appear in at least 2 frames
    var stablePatterns = [];
    for (var name in patternCounts) {
        if (patternCounts[name].count >= 2) {
            stablePatterns.push(patternCounts[name].data);
        }
    }
    
    return { green: avgGreen, red: avgRed, patterns: stablePatterns };
}

function detectCandles(imgData) {
    var data = imgData.data;
    var w = imgData.width;
    var h = imgData.height;
    
    var top = Math.floor(h * 0.1);
    var bot = Math.floor(h * 0.85);
    var left = Math.floor(w * 0.05);
    var right = Math.floor(w * 0.95);
    var scanW = right - left;
    var scanH = bot - top;
    
    var greenPxTotal = 0, redPxTotal = 0;
    var greenSamples = [], redSamples = [];
    var columns = [];
    var step = Math.max(1, Math.floor(scanW / 300));
    
    for (var x = left; x < right; x += step) {
        var greenPx = 0, redPx = 0;
        
        for (var y = top; y < bot; y++) {
            var i = (y * w + x) * 4;
            var r = data[i], g = data[i+1], b = data[i+2];
            
            var brightness = (r + g + b) / 3;
            if (brightness > 240 || brightness < 15) continue;
            
            var saturation = Math.max(r,g,b) - Math.min(r,g,b);
            if (saturation < 35) continue;
            
            // ===== GREEN DETECTION =====
            var isGreen = false;
            
            // Bright green (MT5): G dominant, B low
            if (g > 90 && g > r * 1.3 && g > b * 1.2) isGreen = true;
            
            // Teal (TradingView): G and B high, R low
            if (r < 100 && g > 80 && b > 70 && (g + b) > r * 2.5) isGreen = true;
            
            // General green
            if (g > r + 25 && g >= b && g > 70) isGreen = true;
            
            // Exclude blue
            if (b > g + 20 && b > r) isGreen = false;
            
            // ===== RED DETECTION =====
            var isRed = false;
            
            // Strong red: R high, G and B low
            if (r > 130 && g < 100 && b < 100 && r > g + 35) isRed = true;
            
            // Dark red
            if (r > 90 && g < 60 && b < 60 && r > g * 1.7) isRed = true;
            
            // Exclude pink/salmon (background)
            if (g > 100 || b > 100) isRed = false;
            
            if (isGreen && !isRed) {
                greenPx++;
                greenPxTotal++;
                if (greenSamples.length < 3 && Math.random() < 0.003) {
                    greenSamples.push('(' + r + ',' + g + ',' + b + ')');
                }
            }
            if (isRed && !isGreen) {
                redPx++;
                redPxTotal++;
                if (redSamples.length < 3 && Math.random() < 0.003) {
                    redSamples.push('(' + r + ',' + g + ',' + b + ')');
                }
            }
        }
        
        var minPx = Math.max(3, Math.floor(scanH * 0.004));
        if (greenPx > minPx && greenPx > redPx * 1.1) {
            columns.push({ x: x, type: 'green' });
        } else if (redPx > minPx && redPx > greenPx * 1.1) {
            columns.push({ x: x, type: 'red' });
        }
    }
    
    // Group columns into candles (ordered left to right)
    var candles = [];
    if (columns.length > 0) {
        var cur = { type: columns[0].type, x: columns[0].x };
        var minGap = Math.floor(scanW / 80);
        
        for (var i = 1; i < columns.length; i++) {
            var c = columns[i];
            if (c.x - cur.x <= minGap && c.type === cur.type) {
                cur.x = c.x;
            } else {
                candles.push({ type: cur.type });
                cur = { type: c.type, x: c.x };
            }
        }
        candles.push({ type: cur.type });
    }
    
    // ========== FOCUS ON LAST (RIGHTMOST) CANDLES ==========
    // Take last 25 candles for trend analysis
    var lastCandles = candles.slice(-25);
    
    var greenCandles = lastCandles.filter(function(c) { return c.type === 'green'; }).length;
    var redCandles = lastCandles.filter(function(c) { return c.type === 'red'; }).length;
    
    // Take last 20 candles for pattern detection
    var patternCandles = candles.slice(-20);
    
    // Detect patterns from last 20 candles (patternCandles)
    var patterns = [];
    if (patternCandles.length >= 3) {
        var last3 = patternCandles.slice(-3);
        if (last3[0].type === 'green' && last3[1].type === 'green' && last3[2].type === 'green') {
            patterns.push({ name: '3 White Soldiers', type: 'bullish', icon: 'üë®‚Äçüë®‚Äçüë¶' });
        }
        if (last3[0].type === 'red' && last3[1].type === 'red' && last3[2].type === 'red') {
            patterns.push({ name: '3 Black Crows', type: 'bearish', icon: 'üê¶‚Äç‚¨õ' });
        }
        
        // Morning Star: red -> any -> green (bullish reversal)
        if (last3[0].type === 'red' && last3[2].type === 'green') {
            patterns.push({ name: 'Morning Star', type: 'bullish', icon: '‚≠ê' });
        }
        // Evening Star: green -> any -> red (bearish reversal)
        if (last3[0].type === 'green' && last3[2].type === 'red') {
            patterns.push({ name: 'Evening Star', type: 'bearish', icon: 'üåô' });
        }
    }
    if (patternCandles.length >= 2) {
        var prev = patternCandles[patternCandles.length - 2];
        var last = patternCandles[patternCandles.length - 1];
        if (prev.type === 'red' && last.type === 'green') {
            patterns.push({ name: 'Bullish Engulfing', type: 'bullish', icon: 'ü´Ç' });
        }
        if (prev.type === 'green' && last.type === 'red') {
            patterns.push({ name: 'Bearish Engulfing', type: 'bearish', icon: 'ü´Ç' });
        }
    }
    
    var totalCandles = candles.length;
    var debug = 'Total: ' + totalCandles + ' | Trend(25): G:' + greenCandles + ' R:' + redCandles + '<br>';
    debug += 'Pixels: G:' + greenPxTotal + ' R:' + redPxTotal + '<br>';
    debug += 'Green: ' + greenSamples.join(' ') + '<br>';
    debug += 'Red: ' + redSamples.join(' ');
    
    return {
        green: greenCandles,
        red: redCandles,
        patterns: patterns,
        debug: debug
    };
}
</script>
</body>
</html>
