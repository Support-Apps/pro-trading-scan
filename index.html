<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TradeScan Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0B0E11; --card: #1a1d21; --border: rgba(255,255,255,0.08); --gold: #F0B90B; --green: #0ECB81; --red: #F6465D; --text: #EAECEF; --dim: #848E9C; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        .intro-page { min-height: 100vh; padding: 20px; padding-bottom: 100px; }
        .intro-page.hidden { display: none; }
        .intro-header { text-align: center; padding: 30px 0 20px; }
        .intro-logo { width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, var(--gold), #D4A017); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; }
        .intro-header h1 { font-size: 1.8em; font-weight: 800; color: var(--gold); }
        .intro-header p { color: var(--dim); font-size: 0.9em; margin-top: 4px; }
        .intro-card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 12px; border: 1px solid var(--border); }
        .intro-card h3 { font-size: 1em; margin-bottom: 12px; }
        .intro-card p { color: var(--dim); font-size: 0.85em; line-height: 1.6; margin-bottom: 8px; }
        .pattern-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag { padding: 6px 10px; border-radius: 8px; font-size: 0.75em; font-weight: 600; }
        .tag.green { background: rgba(14,203,129,0.15); color: var(--green); }
        .tag.red { background: rgba(246,70,93,0.15); color: var(--red); }
        .disclaimer { background: rgba(246,70,93,0.08); border: 1px solid rgba(246,70,93,0.2); border-radius: 12px; padding: 14px; }
        .disclaimer p { font-size: 0.8em; color: var(--dim); margin: 0; }
        .intro-btn-wrap { position: fixed; bottom: 0; left: 0; right: 0; padding: 16px 20px 28px; background: linear-gradient(0deg, var(--bg) 70%, transparent); }
        .intro-btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-size: 1em; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--gold), #D4A017); color: #000; }
        
        .scanner-page { display: none; padding: 15px; }
        .scanner-page.active { display: block; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo-sm { display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .logo-sm .icon { width: 28px; height: 28px; background: var(--gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .back-btn { background: rgba(255,255,255,0.1); border: none; color: var(--dim); padding: 8px 14px; border-radius: 8px; font-size: 0.85em; cursor: pointer; }
        
        .camera-area { position: relative; border-radius: 14px; overflow: hidden; background: #000; aspect-ratio: 16/9; border: 2px solid var(--border); margin-bottom: 15px; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; }
        .live-badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 6px; font-size: 0.7em; color: var(--red); }
        .scan-frame { position: absolute; inset: 5%; border: 2px solid rgba(240,185,11,0.4); border-radius: 10px; pointer-events: none; display: none; }
        .scan-frame.active { display: block; }
        
        .result-box { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        .direction { font-size: 2em; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .direction.bullish { color: var(--green); }
        .direction.bearish { color: var(--red); }
        .direction.neutral { color: var(--gold); }
        .confidence { text-align: center; color: var(--dim); font-size: 0.9em; margin-bottom: 15px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; }
        .stat .num { font-size: 1.8em; font-weight: 800; }
        .stat .num.green { color: var(--green); }
        .stat .num.red { color: var(--red); }
        .stat .lbl { font-size: 0.8em; color: var(--dim); }
        .patterns { margin-top: 15px; }
        .patterns-title { font-size: 0.85em; color: var(--dim); margin-bottom: 8px; }
        .pat { display: inline-block; padding: 8px 12px; border-radius: 8px; margin: 4px; font-size: 0.85em; font-weight: 600; }
        .pat.bullish { background: rgba(14,203,129,0.15); color: var(--green); }
        .pat.bearish { background: rgba(246,70,93,0.15); color: var(--red); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; }
        .btn.start { background: var(--green); color: #fff; }
        .btn.stop { background: var(--red); color: #fff; }
    </style>
</head>
<body>
    <div class="intro-page" id="introPage">
        <div class="intro-header">
            <div class="intro-logo">üìà</div>
            <h1>TradeScan Pro</h1>
            <p>AI Candlestick Pattern Scanner</p>
        </div>
        <div class="intro-card">
            <h3>üéØ Real-Time Chart Analysis</h3>
            <p>Point your camera at any candlestick chart. The AI analyzes the last 25 candles to detect the current trend and identifies patterns from the last 20 candles.</p>
        </div>
        <div class="intro-card">
            <h3>üïØÔ∏è Detected Patterns</h3>
            <p>The scanner recognizes these Japanese candlestick patterns:</p>
            <div class="pattern-tags">
                <span class="tag green">üë®‚Äçüë®‚Äçüë¶ 3 White Soldiers</span>
                <span class="tag green">ü´Ç Bullish Engulfing</span>
                <span class="tag green">‚≠ê Morning Star</span>
                <span class="tag red">üê¶‚Äç‚¨õ 3 Black Crows</span>
                <span class="tag red">ü´Ç Bearish Engulfing</span>
                <span class="tag red">üåô Evening Star</span>
            </div>
        </div>
        <div class="intro-card">
            <h3>üìä Supported Charts</h3>
            <p>Works with TradingView, MT4, MT5, and most charting platforms. Supports both light and dark backgrounds.</p>
        </div>
        <div class="disclaimer">
            <p>‚ö†Ô∏è <strong>Risk Warning:</strong> Educational tool only. Not financial advice. Always manage your risk.</p>
        </div>
        <div class="intro-btn-wrap">
            <button class="intro-btn" onclick="showScanner()">‚Üí Open Scanner</button>
        </div>
    </div>
    
    <div class="scanner-page" id="scannerPage">
        <div class="top-bar">
            <div class="logo-sm"><div class="icon">üìà</div> TradeScan</div>
            <button class="back-btn" onclick="showIntro()">‚Üê Back</button>
        </div>
        
        <div class="camera-area">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="scan-frame" id="scanFrame"></div>
            <div class="live-badge" id="liveBadge" style="display:none;">‚óè LIVE</div>
        </div>
        
        <div class="result-box">
            <div class="direction neutral" id="direction">WAITING</div>
            <div class="confidence" id="confidence"></div>
            <div class="stats">
                <div class="stat">
                    <div class="num green" id="greenCount">0</div>
                    <div class="lbl">GREEN (Bullish)</div>
                </div>
                <div class="stat">
                    <div class="num red" id="redCount">0</div>
                    <div class="lbl">RED (Bearish)</div>
                </div>
            </div>
            <div class="patterns">
                <div class="patterns-title">üïØÔ∏è Patterns Detected</div>
                <div id="patterns"><span style="color:#666">No patterns</span></div>
            </div>
        </div>
        
        <button class="btn start" id="scanBtn" onclick="toggleScan()">Start Scanning</button>
    </div>

<script>
var scanning = false;
var stream = null;
var video, canvas, ctx;
var historyResults = [];

function showScanner() {
    document.getElementById('introPage').classList.add('hidden');
    document.getElementById('scannerPage').classList.add('active');
}

function showIntro() {
    stopScan();
    document.getElementById('scannerPage').classList.remove('active');
    document.getElementById('introPage').classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d', { willReadFrequently: true });
});

function toggleScan() {
    if (scanning) stopScan();
    else startScan();
}

function startScan() {
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(function(s) {
        stream = s;
        video.srcObject = stream;
        scanning = true;
        historyResults = [];
        document.getElementById('liveBadge').style.display = 'block';
        document.getElementById('scanFrame').classList.add('active');
        document.getElementById('scanBtn').className = 'btn stop';
        document.getElementById('scanBtn').textContent = 'Stop Scanning';
        analyze();
    }).catch(function(e) {
        alert('Camera error: ' + e.message);
    });
}

function stopScan() {
    scanning = false;
    if (stream) stream.getTracks().forEach(function(t) { t.stop(); });
    document.getElementById('liveBadge').style.display = 'none';
    document.getElementById('scanFrame').classList.remove('active');
    document.getElementById('scanBtn').className = 'btn start';
    document.getElementById('scanBtn').textContent = 'Start Scanning';
}

function analyze() {
    if (!scanning) return;
    
    if (video.videoWidth > 0) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var result = detectCandles(imgData);
        
        historyResults.push(result);
        if (historyResults.length > 8) historyResults.shift();
        
        var stable = getStableResult();
        
        document.getElementById('greenCount').textContent = stable.green;
        document.getElementById('redCount').textContent = stable.red;
        
        var dirEl = document.getElementById('direction');
        var confEl = document.getElementById('confidence');
        
        if (stable.green > stable.red) {
            dirEl.textContent = 'üìà BULLISH';
            dirEl.className = 'direction bullish';
            var conf = Math.round((stable.green / (stable.green + stable.red)) * 100);
            confEl.textContent = conf + '% bullish momentum';
        } else if (stable.red > stable.green) {
            dirEl.textContent = 'üìâ BEARISH';
            dirEl.className = 'direction bearish';
            var conf = Math.round((stable.red / (stable.green + stable.red)) * 100);
            confEl.textContent = conf + '% bearish momentum';
        } else {
            dirEl.textContent = 'üìä NEUTRAL';
            dirEl.className = 'direction neutral';
            confEl.textContent = 'Market is undecided';
        }
        
        var patsHTML = '';
        stable.patterns.forEach(function(p) {
            patsHTML += '<span class="pat ' + p.type + '">' + p.icon + ' ' + p.name + '</span>';
        });
        document.getElementById('patterns').innerHTML = patsHTML || '<span style="color:#666">No patterns</span>';
    }
    
    setTimeout(analyze, 250);
}

function getStableResult() {
    if (historyResults.length === 0) return { green: 0, red: 0, patterns: [] };
    
    var totalGreen = 0, totalRed = 0;
    var patternCounts = {};
    
    historyResults.forEach(function(r) {
        totalGreen += r.green;
        totalRed += r.red;
        r.patterns.forEach(function(p) {
            patternCounts[p.name] = patternCounts[p.name] || { count: 0, data: p };
            patternCounts[p.name].count++;
        });
    });
    
    var avgGreen = Math.round(totalGreen / historyResults.length);
    var avgRed = Math.round(totalRed / historyResults.length);
    
    var stablePatterns = [];
    for (var name in patternCounts) {
        if (patternCounts[name].count >= 2) {
            stablePatterns.push(patternCounts[name].data);
        }
    }
    
    return { green: avgGreen, red: avgRed, patterns: stablePatterns };
}

function detectCandles(imgData) {
    var data = imgData.data;
    var w = imgData.width;
    var h = imgData.height;
    
    var top = Math.floor(h * 0.1);
    var bot = Math.floor(h * 0.85);
    var left = Math.floor(w * 0.05);
    var right = Math.floor(w * 0.95);
    var scanW = right - left;
    var scanH = bot - top;
    
    var columns = [];
    var step = Math.max(1, Math.floor(scanW / 300));
    
    for (var x = left; x < right; x += step) {
        var greenPx = 0, redPx = 0;
        
        for (var y = top; y < bot; y++) {
            var i = (y * w + x) * 4;
            var r = data[i], g = data[i+1], b = data[i+2];
            
            var brightness = (r + g + b) / 3;
            if (brightness > 240 || brightness < 15) continue;
            
            var saturation = Math.max(r,g,b) - Math.min(r,g,b);
            if (saturation < 35) continue;
            
            // GREEN DETECTION
            var isGreen = false;
            if (g > 90 && g > r * 1.3 && g > b * 1.2) isGreen = true;
            if (r < 100 && g > 80 && b > 70 && (g + b) > r * 2.5) isGreen = true;
            if (g > r + 25 && g >= b && g > 70) isGreen = true;
            if (b > g + 20 && b > r) isGreen = false;
            
            // RED DETECTION
            var isRed = false;
            if (r > 130 && g < 100 && b < 100 && r > g + 35) isRed = true;
            if (r > 90 && g < 60 && b < 60 && r > g * 1.7) isRed = true;
            if (g > 100 || b > 100) isRed = false;
            
            if (isGreen && !isRed) greenPx++;
            if (isRed && !isGreen) redPx++;
        }
        
        var minPx = Math.max(3, Math.floor(scanH * 0.004));
        if (greenPx > minPx && greenPx > redPx * 1.1) {
            columns.push({ x: x, type: 'green' });
        } else if (redPx > minPx && redPx > greenPx * 1.1) {
            columns.push({ x: x, type: 'red' });
        }
    }
    
    // Group columns into candles
    var candles = [];
    if (columns.length > 0) {
        var cur = { type: columns[0].type, x: columns[0].x };
        var minGap = Math.floor(scanW / 80);
        
        for (var i = 1; i < columns.length; i++) {
            var c = columns[i];
            if (c.x - cur.x <= minGap && c.type === cur.type) {
                cur.x = c.x;
            } else {
                candles.push({ type: cur.type });
                cur = { type: c.type, x: c.x };
            }
        }
        candles.push({ type: cur.type });
    }
    
    // TREND: Last 25 candles
    var lastCandles = candles.slice(-25);
    var greenCandles = lastCandles.filter(function(c) { return c.type === 'green'; }).length;
    var redCandles = lastCandles.filter(function(c) { return c.type === 'red'; }).length;
    
    // PATTERNS: Last 20 candles
    var patternCandles = candles.slice(-20);
    var patterns = [];
    
    if (patternCandles.length >= 3) {
        var last3 = patternCandles.slice(-3);
        if (last3[0].type === 'green' && last3[1].type === 'green' && last3[2].type === 'green') {
            patterns.push({ name: '3 White Soldiers', type: 'bullish', icon: 'üë®‚Äçüë®‚Äçüë¶' });
        }
        if (last3[0].type === 'red' && last3[1].type === 'red' && last3[2].type === 'red') {
            patterns.push({ name: '3 Black Crows', type: 'bearish', icon: 'üê¶‚Äç‚¨õ' });
        }
        if (last3[0].type === 'red' && last3[2].type === 'green') {
            patterns.push({ name: 'Morning Star', type: 'bullish', icon: '‚≠ê' });
        }
        if (last3[0].type === 'green' && last3[2].type === 'red') {
            patterns.push({ name: 'Evening Star', type: 'bearish', icon: 'üåô' });
        }
    }
    if (patternCandles.length >= 2) {
        var prev = patternCandles[patternCandles.length - 2];
        var last = patternCandles[patternCandles.length - 1];
        if (prev.type === 'red' && last.type === 'green') {
            patterns.push({ name: 'Bullish Engulfing', type: 'bullish', icon: 'ü´Ç' });
        }
        if (prev.type === 'green' && last.type === 'red') {
            patterns.push({ name: 'Bearish Engulfing', type: 'bearish', icon: 'ü´Ç' });
        }
    }
    
    return {
        green: greenCandles,
        red: redCandles,
        patterns: patterns
    };
}
</script>
</body>
</html>
